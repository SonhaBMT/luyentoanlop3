<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√¢n Ch∆°i To√°n H·ªçc Vui V·∫ª</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Bi·∫øn CSS cho ch·∫ø ƒë·ªô S√°ng v√† T·ªëi */
        :root {
            --primary-color: #ff6f61; /* Coral Red */
            --primary-dark: #ff574b;
            --secondary-color: #2ec4b6; /* Teal */
            --secondary-dark: #29b2a6;
            --background-light: #fef9ef; /* Off-white */
            --card-background-light: #ffffff;
            --text-dark: #333333;
            --text-light: #ffffff;
            --border-color: #ffd8a1;
            --shadow-light: rgba(255, 111, 97, 0.2);
            --correct-color: #6a994e; /* Green */
            --incorrect-color: #e63946; /* Red */
            --info-color: #555555;
            --link-color: #007bff;
        }

        /* Ch·∫ø ƒë·ªô T·ªëi (Dark Mode) - M√†u s·∫Øc tr·∫ßm h∆°n, th√¢n thi·ªán v·ªõi m·∫Øt */
        body.dark-mode {
            --primary-color: #8e9aaf;
            --primary-dark: #6e7a93;
            --secondary-color: #43aa8b;
            --secondary-dark: #3a977c;
            --background-light: #2c3e50;
            --card-background-light: #34495e;
            --text-dark: #ecf0f1;
            --border-color: #55718a;
            --shadow-light: rgba(0, 0, 0, 0.2);
            --correct-color: #43aa8b;
            --incorrect-color: #e63946;
            --info-color: #b0b0b0;
            --link-color: #b0b0b0;
        }

        /* ----- Thi·∫øt l·∫≠p c∆° b·∫£n ----- */
        * {
            box-sizing: border-box;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        
        body {
            font-family: 'Times New Roman', serif; /* √Åp d·ª•ng font m·ªõi */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background: var(--background-light);
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJyZ2JhKDI1NSwyNDEsMjA4LDAuNSkiIGZpbGwtb3BhY2l0eT0iMC41IiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxwYXRoIGQ9Ik0wIDQwTDQwIDAgTDUgMEwwIDVMMCA0MHpNMCAxOUw0MCAzOWwwLTUwTDUgNDBsLTMtMzF6TTE1IDBMMCAxNUwxNSA0MGwxNS0xNUwxNSAwem01LTUwTDAgLTUwbDUgMzBsLTMgMjBMMzAgMjBsLTUtMzV6Ii8+PC9nPg==');
            margin: 0;
            padding: 25px;
            color: var(--text-dark);
            background-size: 100px;
        }

        body.dark-mode {
            background-image: none;
        }

        .main-wrapper {
            display: flex;
            gap: 25px;
            width: 100%;
            max-width: 1200px;
        }

        .main-content {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
        }

        .card {
            background-color: var(--card-background-light);
            padding: 30px;
            border-radius: 20px; /* Bo g√≥c nhi·ªÅu h∆°n */
            box-shadow: 0 10px 20px var(--shadow-light); /* ƒê·ªï b√≥ng n·ªïi b·∫≠t */
            width: 100%;
            position: relative;
        }

        .history-container {
            flex: 1;
            max-height: 85vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* ----- Ti√™u ƒë·ªÅ v√† n√∫t chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô ----- */
        h1, h2 {
            font-family: 'Times New Roman', serif;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 700;
        }
        h1 { font-size: 2.5em; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        h2 { 
            font-size: 1.8em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 25px;
            color: var(--secondary-color);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 2em; /* Icon to h∆°n */
            color: var(--info-color);
        }
        .theme-toggle:hover { color: var(--text-dark); }
        .dark-mode .theme-toggle { color: var(--text-light); }
        .dark-mode .theme-toggle:hover { color: var(--primary-color); }

        /* ----- N·ªôi dung ch√≠nh ----- */
        #equation {
            margin-bottom: 30px;
            font-size: 4em; /* S·ªë to h∆°n */
            font-weight: 700;
            color: var(--text-dark);
            text-align: center;
            animation: bounceIn 0.8s forwards; /* Hi·ªáu ·ª©ng ƒë·ªông khi xu·∫•t hi·ªán */
        }
        @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }

        .answer-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px; /* Kho·∫£ng c√°ch l·ªõn h∆°n */
            margin-bottom: 20px;
        }

        .answer-options button {
            padding: 20px;
            font-size: 2em;
            background-color: var(--primary-color);
            color: var(--text-light);
            border: 4px solid var(--primary-color); /* Vi·ªÅn n·ªïi b·∫≠t */
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--primary-dark);
            font-weight: 700;
            transform: translateY(0);
        }

        .answer-options button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 0 var(--primary-dark);
        }
        .answer-options button:active {
            transform: translateY(0);
            box-shadow: 0 4px 0 var(--primary-dark);
        }

        .answer-options button.correct-option {
            background-color: var(--correct-color);
            border-color: #4a6c38;
            box-shadow: 0 4px 0 #4a6c38;
        }
        .answer-options button.incorrect-option {
            background-color: var(--incorrect-color);
            border-color: #b72733;
            box-shadow: 0 4px 0 #b72733;
        }

        #result {
            margin-top: 20px;
            font-size: 2.5em;
            font-weight: 700;
            text-align: center;
            height: 50px;
            animation: fadeInUp 0.5s forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .correct { color: var(--correct-color); }
        .incorrect { color: var(--incorrect-color); }

        /* ----- B·∫£ng th·ªëng k√™ ----- */
        .stats-container h2, .history-container h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-container h2 i, .history-container h2 i {
            color: var(--secondary-color);
        }

        .stat-line {
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-line i { margin-right: 10px; color: var(--primary-color); }
        .stat-value {
            font-weight: 700;
            color: var(--text-dark);
        }
        .stat-correct { color: var(--correct-color); }
        .stat-incorrect { color: var(--incorrect-color); }
        
        .progress-bar-container {
            width: 100%;
            height: 15px;
            background-color: var(--border-color);
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--secondary-color);
            transition: width 0.5s ease;
            border-radius: 8px;
        }
        .trophy-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: gold;
        }

        /* ----- L·ªãch s·ª≠ ----- */
        .history-list-scroll {
            flex-grow: 1;
            overflow-y: auto;
        }
        .history-item {
            padding: 12px 0;
            border-bottom: 1px dashed var(--border-color);
            text-align: left;
            font-size: 1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .history-item:first-child { animation-delay: 0.1s; }
        .history-item:last-child { border-bottom: none; }
        .history-text { flex-grow: 1; }
        .history-correct { color: var(--correct-color); font-weight: 700; }
        .history-incorrect { color: var(--incorrect-color); font-weight: 700; }
        .time-taken { font-size: 0.8em; color: var(--info-color); white-space: nowrap; margin-left: 10px; }
        .history-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .history-controls button {
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            color: var(--text-light);
            font-weight: 700;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .history-controls button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }
        .history-controls button.clear-button { background-color: var(--incorrect-color); }
        .history-controls button.clear-button:hover { background-color: #c82333; }
        .history-controls button.download-button { background-color: var(--primary-color); }
        .history-controls button.download-button:hover { background-color: var(--primary-dark); }
        
        /* ----- Hi·ªáu ·ª©ng v√† animation ----- */
        #trophy-animation {
            font-size: 8em;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            color: gold;
            text-shadow: 4px 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            pointer-events: none;
        }
        #trophy-animation.show {
            animation: popAndBounce 0.8s forwards;
        }
        @keyframes popAndBounce {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            75% { transform: translate(-50%, -50%) scale(0.9); }
            100% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
        }
        .fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }
        .firework {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            opacity: 0;
            animation: firework-burst 1s forwards ease-out;
            box-shadow: 0 0 10px 5px;
        }
        @keyframes firework-burst {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(0) translateY(50px); opacity: 0; }
        }

        /* ----- Responsive design ----- */
        @media (max-width: 900px) {
            .main-wrapper { flex-direction: column; align-items: center; }
            .main-content, .history-container { flex: none; width: 100%; }
            .history-container { max-height: 50vh; margin-top: 25px; }
            body { padding: 15px; }
            h1 { font-size: 2em; }
            h2 { font-size: 1.5em; }
            #equation { font-size: 3em; }
            .answer-options { gap: 10px; }
            .answer-options button { padding: 15px; font-size: 1.8em; }
            .stat-line { font-size: 1em; }
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="main-content">
            <div class="card">
                <div class="header-content">
                    <h1><i class="fas fa-rocket"></i> S√¢n Ch∆°i To√°n H·ªçc Vui V·∫ª</h1>
                    <i class="fas fa-moon theme-toggle" id="themeToggle"></i>
                </div>
                <div id="equation"></div>
                <div id="answerOptions" class="answer-options"></div>
                <div id="result"></div>
                <div id="trophy-animation">üèÜ</div>
            </div>
            
            <div class="card stats-container">
                <h2><i class="fas fa-chart-line"></i> B·∫£ng th√†nh t√≠ch c·ªßa b√©</h2>
                <div class="stat-line">
                    <span>T·ªïng s·ªë c√¢u:</span> <span id="totalQuestions" class="stat-value">0</span>
                </div>
                <div class="stat-line">
                    <span>S·ªë c√¢u ƒë√∫ng:</span> <span id="correctQuestions" class="stat-value stat-correct">0</span>
                </div>
                <div class="stat-line">
                    <span>S·ªë c√¢u sai:</span> <span id="incorrectQuestions" class="stat-value stat-incorrect">0</span>
                </div>
                <div class="stat-line">
                    <span>T·ªïng th·ªùi gian:</span> <span id="totalTime" class="stat-value">00:00:00</span>
                </div>
                <div class="stat-line">
                    <span>C√∫p nh·∫≠n ƒë∆∞·ª£c:</span>
                    <span id="trophyCountDisplay" class="trophy-container">
                        <i class="fas fa-trophy"></i>
                        <span class="stat-value">0</span>
                    </span>
                </div>
                <div class="progress-bar-container">
                    <div id="correctProgressBar" class="progress-bar"></div>
                </div>
            </div>
        </div>
        
        <div class="card history-container">
            <h2><i class="fas fa-book-open"></i> Nh·∫≠t k√Ω luy·ªán t·∫≠p</h2>
            <div id="historyList" class="history-list-scroll"></div>
            <div class="history-controls">
                <button onclick="clearHistoryAndStats()" class="clear-button"><i class="fas fa-trash-alt"></i> X√≥a</button>
                <button onclick="downloadHistoryAsIni()" class="download-button"><i class="fas fa-download"></i> T·∫£i v·ªÅ</button>
            </div>
        </div>
    </div>
    
    <div class="fireworks-container" id="fireworks-container"></div>
    
    <audio id="correctSound" src="path/to/correct_sound.mp3" preload="auto"></audio>
    <audio id="incorrectSound" src="path/to/incorrect_sound.mp3" preload="auto"></audio>
    
    <script>
        // Khai b√°o bi·∫øn
        let currentNum1, currentNum2, currentOperation, startTime, correctAnswer, selectedAnswer = null;
        let totalQuestions = 0, correctQuestions = 0, incorrectQuestions = 0, totalElapsedTime = 0, trophyCount = 0;
        let mathHistory = [];
        const historyLimit = 500;
        let timerInterval;

        const correctSound = document.getElementById('correctSound');
        const incorrectSound = document.getElementById('incorrectSound');
        const themeToggle = document.getElementById('themeToggle');

        // C√°c h√†m h·ªó tr·ª£
        function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™ tr√™n giao di·ªán
        function updateStatsDisplay() {
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('correctQuestions').textContent = correctQuestions;
            document.getElementById('incorrectQuestions').textContent = incorrectQuestions;
            document.getElementById('trophyCountDisplay').querySelector('.stat-value').textContent = trophyCount;
            const percentage = totalQuestions > 0 ? (correctQuestions / totalQuestions) * 100 : 0;
            document.getElementById('correctProgressBar').style.width = `${percentage}%`;
        }

        // L∆∞u d·ªØ li·ªáu v√†o Local Storage
        function saveToLocalStorage() {
            localStorage.setItem('mathHistory', JSON.stringify(mathHistory));
            localStorage.setItem('totalQuestions', totalQuestions);
            localStorage.setItem('correctQuestions', correctQuestions);
            localStorage.setItem('incorrectQuestions', incorrectQuestions);
            localStorage.setItem('totalElapsedTime', totalElapsedTime);
            localStorage.setItem('trophyCount', trophyCount);
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ Local Storage
        function loadFromLocalStorage() {
            const savedHistory = localStorage.getItem('mathHistory');
            const savedTotalQuestions = localStorage.getItem('totalQuestions');
            const savedCorrectQuestions = localStorage.getItem('correctQuestions');
            const savedIncorrectQuestions = localStorage.getItem('incorrectQuestions');
            const savedTotalElapsedTime = localStorage.getItem('totalElapsedTime');
            const savedTrophyCount = localStorage.getItem('trophyCount');

            if (savedHistory) {
                mathHistory = JSON.parse(savedHistory);
                mathHistory.forEach(item => updateHistoryDisplay(item, true));
            }
            if (savedTotalQuestions) totalQuestions = parseInt(savedTotalQuestions);
            if (savedCorrectQuestions) correctQuestions = parseInt(savedCorrectQuestions);
            if (savedIncorrectQuestions) incorrectQuestions = parseInt(savedIncorrectQuestions);
            if (savedTotalElapsedTime) totalElapsedTime = parseInt(savedTotalElapsedTime);
            if (savedTrophyCount) trophyCount = parseInt(savedTrophyCount);
        }

        // T·∫°o c√°c l·ª±a ch·ªçn ƒë√°p √°n
        function generateAnswerOptions(correctAnswer) {
            const optionsDiv = document.getElementById('answerOptions');
            optionsDiv.innerHTML = '';
            selectedAnswer = null;
            let answers = new Set();
            answers.add(correctAnswer);

            while (answers.size < 4) {
                let randomWrongAnswer = getRandomInt(Math.max(0, correctAnswer - 15), correctAnswer + 15);
                if (randomWrongAnswer !== correctAnswer) {
                     if (currentOperation === 'division' && !Number.isInteger(randomWrongAnswer)) continue;
                    answers.add(randomWrongAnswer);
                }
            }
            let shuffledAnswers = Array.from(answers).sort(() => Math.random() - 0.5);

            shuffledAnswers.forEach(ans => {
                const button = document.createElement('button');
                button.textContent = ans;
                button.onclick = () => selectAnswer(ans, button);
                optionsDiv.appendChild(button);
            });
        }

        // Ch·ªçn ƒë√°p √°n
        function selectAnswer(answer, button) {
            selectedAnswer = answer;
            checkOperation();
        }

        // T·∫°o ph√©p t√≠nh m·ªõi
        function generateNewNumbers() {
            const operations = ['division', 'multiplication', 'addition', 'subtraction'];
            currentOperation = operations[Math.floor(Math.random() * operations.length)];
            let num1, num2;

            switch (currentOperation) {
                case 'division':
                    const maxA = 90, maxB = 10;
                    do { num2 = getRandomInt(1, maxB); num1 = num2 * getRandomInt(1, 10); } while (num1 === 0);
                    currentNum1 = num1; currentNum2 = num2; correctAnswer = currentNum1 / currentNum2;
                    break;
                case 'multiplication':
                    currentNum1 = getRandomInt(1, 9); currentNum2 = getRandomInt(1, 9); correctAnswer = currentNum1 * currentNum2;
                    break;
                case 'addition':
                    currentNum1 = getRandomInt(1, 99); currentNum2 = getRandomInt(1, 99); correctAnswer = currentNum1 + currentNum2;
                    break;
                case 'subtraction':
                    currentNum1 = getRandomInt(1, 99); currentNum2 = getRandomInt(1, 99);
                    if (currentNum1 < currentNum2) [currentNum1, currentNum2] = [currentNum2, currentNum1];
                    correctAnswer = currentNum1 - currentNum2;
                    break;
            }

            document.getElementById('equation').textContent = `${currentNum1} ${getOperatorSymbol(currentOperation)} ${currentNum2} = ?`;
            document.getElementById('result').textContent = '';
            document.getElementById('result').className = '';
            generateAnswerOptions(correctAnswer);
            startTime = new Date().getTime();
        }

        // L·∫•y k√Ω hi·ªáu ph√©p to√°n
        function getOperatorSymbol(op) {
            switch (op) {
                case 'division': return '√∑';
                case 'multiplication': return '√ó';
                case 'addition': return '+';
                case 'subtraction': return '-';
            }
        }

        // C·∫≠p nh·∫≠t l·ªãch s·ª≠ tr√™n giao di·ªán
        function updateHistoryDisplay(item, isFromLoad = false) {
            const historyList = document.getElementById('historyList');
            const historyItemDiv = document.createElement('div');
            historyItemDiv.className = 'history-item';
            let resultClass = item.isCorrect ? 'history-correct' : 'history-incorrect';
            historyItemDiv.innerHTML = `<span class="history-text">${item.equation.replace('= ?', '=')} <span class="${resultClass}">[${item.userAnswer}]</span></span><span class="time-taken">(${item.timeTaken}s)</span>`;
            if (isFromLoad) {
                historyList.appendChild(historyItemDiv);
            } else {
                historyList.prepend(historyItemDiv);
            }
            while (historyList.children.length > historyLimit) historyList.removeChild(historyList.lastChild);
        }

        // K√≠ch ho·∫°t hi·ªáu ·ª©ng c√∫p v√† ph√°o hoa
        function triggerConfettiAndTrophy() {
            const trophy = document.getElementById('trophy-animation');
            trophy.classList.add('show');
            const fireworksContainer = document.getElementById('fireworks-container');
            const colors = ['#f44141', '#f6901a', '#54c41f', '#2196f3', '#9c27b0'];
            for (let i = 0; i < 50; i++) {
                const firework = document.createElement('div');
                firework.className = 'firework';
                firework.style.backgroundColor = colors[getRandomInt(0, colors.length - 1)];
                firework.style.left = `${getRandomInt(10, 90)}vw`;
                firework.style.top = `${getRandomInt(10, 80)}vh`;
                firework.style.animationDelay = `${i * 0.02}s`;
                fireworksContainer.appendChild(firework);
            }
            setTimeout(() => { trophy.classList.remove('show'); fireworksContainer.innerHTML = ''; }, 2000);
        }

        // Ki·ªÉm tra ƒë√°p √°n
        function checkOperation() {
            const resultDiv = document.getElementById('result');
            const endTime = new Date().getTime();
            const timeTakenSeconds = ((endTime - startTime) / 1000).toFixed(1);
            const isCorrect = (selectedAnswer === correctAnswer);
            
            document.querySelectorAll('#answerOptions button').forEach(button => {
                const buttonValue = parseInt(button.textContent);
                if (buttonValue === correctAnswer) {
                    button.classList.add('correct-option');
                } else if (buttonValue === selectedAnswer && !isCorrect) {
                    button.classList.add('incorrect-option');
                }
                button.disabled = true;
            });
            if (isCorrect) {
                resultDiv.innerHTML = 'ƒê√öNG! <i class="fas fa-smile-beam"></i>';
                resultDiv.className = 'correct';
                correctQuestions++;
                trophyCount++;
                triggerConfettiAndTrophy();
                correctSound.play();
            } else {
                resultDiv.innerHTML = `SAI! K·∫øt qu·∫£ ƒë√∫ng l√† ${correctAnswer}. <i class="fas fa-frown"></i>`;
                resultDiv.className = 'incorrect';
                incorrectQuestions++;
                incorrectSound.play();
            }
            totalQuestions++;
            totalElapsedTime += (endTime - startTime);
            updateStatsDisplay();

            const historyEntry = {
                equation: `${currentNum1} ${getOperatorSymbol(currentOperation)} ${currentNum2} = ?`,
                userAnswer: selectedAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                timeTaken: parseFloat(timeTakenSeconds)
            };
            mathHistory.unshift(historyEntry);
            if (mathHistory.length > historyLimit) mathHistory.pop();
            updateHistoryDisplay(historyEntry);
            saveToLocalStorage();

            setTimeout(() => {
                document.querySelectorAll('#answerOptions button').forEach(button => {
                    button.disabled = false;
                    button.classList.remove('correct-option', 'incorrect-option');
                });
                generateNewNumbers();
            }, 1500);
        }

        // X√≥a l·ªãch s·ª≠ v√† th·ªëng k√™
        function clearHistoryAndStats() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ v√† th·ªëng k√™ kh√¥ng?')) {
                totalQuestions = 0; correctQuestions = 0; incorrectQuestions = 0; totalElapsedTime = 0; trophyCount = 0;
                mathHistory = [];
                updateStatsDisplay();
                document.getElementById('totalTime').textContent = '00:00:00';
                document.getElementById('historyList').innerHTML = '';
                saveToLocalStorage();
                generateNewNumbers();
            }
        }

        // T·∫£i l·ªãch s·ª≠ d∆∞·ªõi d·∫°ng .ini
        function downloadHistoryAsIni() {
            let iniContent = '[Stats]\n';
            iniContent += `TotalQuestions=${totalQuestions}\n`;
            iniContent += `CorrectQuestions=${correctQuestions}\n`;
            iniContent += `IncorrectQuestions=${incorrectQuestions}\n`;
            iniContent += `TotalTime=${formatTime(totalElapsedTime)}\n`;
            iniContent += `TrophyCount=${trophyCount}\n\n`;
            iniContent += '[History]\n';
            mathHistory.forEach((item, index) => {
                iniContent += `Entry${index + 1}=${item.equation.replace('= ?', '=')} UserAnswer=${item.userAnswer} CorrectAnswer=${item.correctAnswer} IsCorrect=${item.isCorrect} TimeTaken=${item.timeTaken}s\n`;
            });
            const blob = new Blob([iniContent], { type: 'text/plain;charset=utf-8' });
            const today = new Date();
            const filename = `math_practice_log_${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}.ini`;
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(a.href);
        }

        // Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô S√°ng/T·ªëi
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (isDarkMode) {
                themeToggle.classList.remove('fa-moon');
                themeToggle.classList.add('fa-sun');
            } else {
                themeToggle.classList.remove('fa-sun');
                themeToggle.classList.add('fa-moon');
            }
            localStorage.setItem('darkMode', isDarkMode);
        }

        // √Åp d·ª•ng ch·ªß ƒë·ªÅ ƒë√£ l∆∞u
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            if (savedTheme === 'true') {
                document.body.classList.add('dark-mode');
                themeToggle.classList.remove('fa-moon');
                themeToggle.classList.add('fa-sun');
            }
        }

        // Kh·ªüi t·∫°o trang
        window.onload = () => {
            applySavedTheme();
            loadFromLocalStorage();
            generateNewNumbers();
            updateStatsDisplay();
            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                document.getElementById('totalTime').textContent = formatTime(totalElapsedTime + (now - startTime));
            }, 1000);
            themeToggle.addEventListener('click', toggleDarkMode);
        };
    </script>
</body>
</html>
